# 自定义模块功能说明

本文档详细说明 `/opt/custom/addons` 目录下所有自定义模块的功能和特性。

## 模块列表

### 1. stock_unit_mgmt (库存单位管理器) ⭐ 核心模块

**版本**: 1.0.0  
**作者**: memory  
**依赖**: base, product, stock, stock_barcode, uom, purchase, sale

#### 核心功能

1. **产品单位配置**
   - 支持多种预定义单位（卷、桶、箱、袋、公斤、平方米等）
   - 支持自定义单位
   - 快速配置向导
   - 单位配置模板

2. **库存移动单位管理**
   - 库存移动行单位信息记录（`lot_quantity`, `lot_unit_name`）
   - 批次/序列号与单位关联
   - 单位数量自动计算
   - 动态单位选择和验证

3. **增强条码验证**（可选功能）
   - 作业类型级别配置（`enable_enhanced_barcode_validation`）
   - 批次号验证（预填列表匹配）
   - 重复扫描检测
   - 数量一致性验证
   - 扫码时按照序列号逻辑处理批次号（quantity = 1.0）

4. **产品属性管理**
   - 产品类型分类（原膜、成品膜、配液原料）
   - 产品尺寸管理（宽度、长度、厚度）
   - 自动计算面积和体积
   - 材料密度和固含量管理

5. **库存统计**
   - 实际卷数统计
   - 桶数统计
   - 单位数量汇总（`stock_quant.lot_quantity`）
   - 安全库存预警

6. **扫描顺序管理**
   - 包裹中记录按扫描顺序排序（`scan_sequence` 字段）
   - 支持多个包裹
   - 保持扫描时间顺序

#### 关键模型扩展

- `product.template`: 单位配置、产品属性
- `stock.move.line`: 单位数量、单位名称、扫描顺序
- `stock.quant`: 单位数量计算、单位名称
- `stock.picking`: 增强条码验证、单位信息恢复
- `stock.picking.type`: 增强条码验证配置
- `stock.move`: 单位信息传递

#### 关键控制器

- `StockBarcodeController`: 扩展条码扫描功能
  - `get_specific_barcode_data`: 获取条码数据（合并会话中的批次号）
  - `save_barcode_data`: 保存条码数据（设置单位信息、扫描顺序）

#### 关键特性

- **会话管理**: 使用 `request.session` 跟踪已扫描的批次号
- **包裹操作检测**: 自动检测包裹操作，跳过批次号验证
- **单位信息恢复**: 入库后自动恢复 `lot_quantity` 和 `lot_unit_name`
- **序列号产品保护**: 不影响原有序列号产品的逻辑

---

### 2. mrp_production_return (制造订单剩余产品返回处理)

**版本**: 2.0  
**作者**: memory  
**依赖**: mrp, stock, stock_account, stock_unit_mgmt

#### 核心功能

1. **剩余组件处理向导**
   - 当制造订单选择"无欠单"时，自动弹出处理向导
   - 显示剩余组件数量和产品信息
   - 提供多种处理方式选择

2. **返回策略**
   - **返回至生产前**: 将剩余组件返回至原材料位置
   - **返回至生产后**: 将剩余组件返回至成品位置
   - **返回至不良品仓**: 将剩余组件返回至不良品仓
   - **报废处理**: 将剩余组件报废

3. **自动库存调拨**
   - 自动创建库存调拨单
   - 支持记录返回原因
   - 自动完成调拨流程

4. **处理历史追踪**
   - 记录返回历史
   - 显示处理原因和备注
   - 支持查看处理日志

#### 关键模型

- `mrp.production.return.wizard`: 返回向导
- `mrp.production.return.wizard.line`: 返回向导行
- `mrp.production.return.history`: 返回历史
- `mrp.return.reason`: 返回原因

#### 关键特性

- **智能位置推荐**: 根据返回策略自动推荐目标位置
- **批量处理**: 支持批量处理多个剩余组件
- **数量验证**: 验证剩余数量是否正确
- **权限控制**: 支持权限控制和安全设置

---

### 3. mrp_auto_lot_generate (生产自动批次生成器)

**版本**: 2.0  
**作者**: memory  
**依赖**: mrp, stock

#### 核心功能

1. **自动批次号生成**
   - 当组件就绪时自动生成完成品批次号
   - 监听移动行，自动触发批次号生成
   - 支持配置批次号前缀

2. **批次号格式**
   - 主批次：`{PREFIX}YYMMDDHHMMAxx`
   - 每个制造单（包括欠单）都生成独立的主批次号
   - 支持自定义前缀（默认：XQ）

3. **配置化支持**
   - 支持全局配置批次号前缀
   - 支持产品级别配置
   - 可配置是否启用详细日志

#### 关键模型

- `mrp.production`: 批次号生成逻辑
- `res.config.settings`: 系统配置

#### 关键特性

- **性能优化**: 优化数据库查询，减少不必要的访问
- **错误处理**: 完整的异常处理机制
- **日志记录**: 增强日志记录，便于问题排查
- **产品跟踪检查**: 只对需要批次号的产品生成批次号

---

### 4. stock_extend (库存扩展)

**版本**: 0.1  
**作者**: My Company  
**依赖**: base, stock

#### 核心功能

1. **库存移动行扩展**
   - 单位件数字段（`lot_quantity`）
   - 单位名称字段（`lot_unit_name`）
   - 动态单位选择

2. **前端扩展**
   - 批次对话框扩展
   - 单位过滤器

#### 关键特性

- **动态单位选择**: 根据产品配置动态显示单位选项
- **前端组件**: 提供前端JavaScript组件

---

### 5. xq_rfid (RFID 标签管理)

**版本**: 18.0.1.0.0  
**作者**: Grit  
**依赖**: base, product, stock, mrp, quality_control, mrp_workorder

#### 核心功能

1. **RFID 标签管理**
   - 统一管理所有 RFID 标签
   - RFID 编号唯一性保证
   - 支持多种使用类型（收货、发货、产品、批次/序列号）

2. **质检集成**
   - 通过质量检查点生成 RFID
   - 质检对话框中显示 RFID 生成界面
   - 自动关联序列号、生产订单、质检记录

3. **生产溯源**
   - 记录生产订单
   - 记录生产日期
   - 记录质检记录
   - 支持批次溯源

4. **设备接口**
   - 预留 RFID 读写器接口
   - 支持 UHFReader18 设备
   - 支持 TCP 连接
   - 设备配置管理

#### 关键模型

- `rfid.tag`: RFID 标签
- `rfid.device.config`: RFID 设备配置
- `uhf_reader18.client`: UHFReader18 客户端
- `quality.point`: 质量控制点扩展
- `quality.check`: 质量检查扩展

#### 关键特性

- **唯一性保证**: 一个 RFID 编号全局唯一，一个序列号只能有一个 RFID
- **自动生成**: 质检通过时自动生成 RFID 标签
- **硬件集成**: 支持 RFID 读写器硬件接口
- **数据关联**: RFID 标签关联序列号、产品、生产订单、质检记录

---

### 6. bi_product_secondary_uom (产品第二单位管理)

**版本**: 18.0.0.0  
**作者**: BROWSEINFO  
**依赖**: base, sale_management, stock, purchase, product

#### 核心功能

1. **产品第二单位配置**
   - 支持为产品配置第二单位
   - 第二单位与主单位的转换
   - 第二单位数量自动计算

2. **销售和采购订单**
   - 销售订单行显示第二单位
   - 采购订单行显示第二单位
   - 第二单位数量自动计算

3. **库存管理**
   - 库存数量显示第二单位
   - 第二单位数量统计
   - 第二单位在手数量

#### 关键模型

- `product.template`: 第二单位配置
- `sale.order.line`: 销售订单行扩展
- `purchase.order.line`: 采购订单行扩展
- `stock.move`: 库存移动扩展
- `stock.quant`: 库存数量扩展

#### 关键特性

- **自动转换**: 第二单位与主单位自动转换
- **数量统计**: 第二单位数量自动统计
- **视图集成**: 集成到销售、采购、库存视图

---

### 7. quality_report (品质报告打印)

**版本**: 1.0  
**作者**: memory  
**依赖**: stock

#### 核心功能

1. **品质报告打印**
   - 在交货单中打印品质报告
   - 显示产品的批号/序列号和品质备注
   - 提供专业的品质报告打印模板

#### 关键模型

- `stock.picking`: 品质信息获取

#### 关键特性

- **品质信息显示**: 显示产品的品质备注
- **批次信息**: 显示批号/序列号信息
- **打印模板**: 提供专业的打印模板

---

### 8. delivery_report (交货单打印增强)

**版本**: 1.0  
**作者**: memory  
**依赖**: base, stock, sale, account

#### 核心功能

1. **交货单打印增强**
   - 在交货单中显示产品的批次/序列号
   - 创建专业的交货单打印模板
   - 支持批次/序列号的详细显示

2. **产品信息显示**
   - 显示产品尺寸（厚度、宽度、米数）
   - 显示产品代码
   - 显示数量信息

#### 关键模型

- `stock.picking`: 批次/序列号信息获取

#### 关键特性

- **批次信息显示**: 显示批号/序列号信息
- **产品尺寸显示**: 显示产品尺寸信息
- **打印模板**: 提供专业的打印模板

---

### 9. product_multi_unit_manager (产品多单位管理器)

**版本**: 1.0  
**作者**: Grit  
**依赖**: product, uom

#### 核心功能

1. **产品多单位配置**
   - 支持为产品配置多个计量单位
   - 快速设置常用单位
   - 单位配置模板

2. **单位配置向导**
   - 批量选择产品
   - 统一设置单位配置
   - 快速应用到多个产品

#### 关键模型

- `product.template`: 单位配置

#### 关键特性

- **快速配置**: 提供快速配置向导
- **批量设置**: 支持批量设置单位配置
- **模板支持**: 支持单位配置模板

---

### 10. ps_multi_image_mrp_qc (多图片 MRP 质检)

**版本**: 18.0.1.0.0  
**作者**: PySquad Informatics LLP  
**依赖**: base, web, quality_control, mrp, mrp_workorder

#### 核心功能

1. **多图片选择**
   - 在 MRP 质检过程中选择多张图片
   - 同时管理多张图片
   - 提高质检效率

2. **图片管理**
   - 图片上传和存储
   - 图片查看和删除
   - 图片关联质检记录

#### 关键特性

- **多图片支持**: 支持选择多张图片
- **前端组件**: 提供前端组件支持
- **图片存储**: 图片存储在系统中

---

### 11. xq_mrp_label (MRP 标签打印)

**版本**: 18.0.1.0.0  
**作者**: Your Company  
**依赖**: mrp, stock, quality_control, mrp_workorder, web

#### 核心功能

1. **MRP 标签打印**
   - 打印 100x100mm 制造订单标签
   - 显示产品名称、规格、数量、批号
   - 支持质检标签打印

2. **标签模板**
   - 产品标签模板
   - 质检标签模板
   - 自定义标签格式

#### 关键模型

- `quality.check`: 标签打印逻辑

#### 关键特性

- **标签格式**: 100x100mm 标签格式
- **多模板支持**: 支持多种标签模板
- **打印功能**: 集成打印功能

---

### 12. serial_no_from_mo (从制造订单生成序列号)

**版本**: 18.0.1.0.0  
**作者**: Cybrosys Techno Solutions  
**依赖**: mrp, stock

#### 核心功能

1. **自动序列号生成**
   - 确认制造订单时自动生成序列号
   - 支持全局配置序列号规则
   - 支持产品级别配置序列号规则

2. **序列号规则配置**
   - 支持配置序列号前缀
   - 支持配置序列号位数
   - 支持全局或产品级别配置

#### 关键模型

- `mrp.production`: 序列号生成逻辑
- `product.template`: 产品序列号配置
- `res.config.settings`: 系统配置

#### 关键特性

- **自动生成**: 确认制造订单时自动生成序列号
- **配置化**: 支持全局或产品级别配置
- **序列号规则**: 支持自定义序列号规则

---

### 13. auto_database_backup (自动数据库备份)

**版本**: 18.0.2.0.1  
**作者**: Cybrosys Techno Solutions  
**依赖**: base, mail

#### 核心功能

1. **自动数据库备份**
   - 支持本地服务器备份
   - 支持远程服务器备份（FTP、SFTP）
   - 支持云存储备份（Google Drive、Dropbox、OneDrive、Nextcloud、Amazon S3）

2. **备份配置**
   - 支持配置备份频率（每日、每周、每月）
   - 支持配置备份格式（ZIP、DUMP）
   - 支持配置备份路径

3. **备份管理**
   - 备份历史记录
   - 备份通知
   - 备份恢复

#### 关键模型

- `db.backup.configure`: 备份配置

#### 关键特性

- **多目标支持**: 支持多种备份目标
- **自动备份**: 支持自动定时备份
- **备份通知**: 支持备份完成通知
- **备份恢复**: 支持备份恢复功能

---

### 14. merge_picking_orders (合并调拨单)

**版本**: 18.0.1.0.0  
**作者**: Cybrosys Techno Solutions  
**依赖**: stock

#### 核心功能

1. **合并调拨单**
   - 合并多个调拨单（收货、发货、退货）
   - 支持选择多个调拨单
   - 自动创建合并后的调拨单

2. **合并向导**
   - 选择要合并的调拨单
   - 预览合并结果
   - 确认合并

#### 关键模型

- `stock.picking`: 合并调拨单逻辑
- `merge.picking`: 合并向导

#### 关键特性

- **批量合并**: 支持批量合并多个调拨单
- **合并预览**: 支持预览合并结果
- **自动创建**: 自动创建合并后的调拨单

---

## 模块关系图

```
stock_unit_mgmt (核心模块)
├── 整合了以下模块的功能：
│   ├── stock_extend
│   ├── bi_product_secondary_uom
│   └── product_multi_unit_manager
├── 依赖模块：
│   ├── base
│   ├── product
│   ├── stock
│   ├── stock_barcode
│   ├── uom
│   ├── purchase
│   └── sale
└── 扩展功能：
    ├── 增强条码验证
    ├── 单位管理
    ├── 扫描顺序管理
    └── 单位信息恢复

mrp_production_return
├── 依赖：mrp, stock, stock_account, stock_unit_mgmt
└── 功能：制造订单剩余组件返回处理

mrp_auto_lot_generate
├── 依赖：mrp, stock
└── 功能：自动批次号生成

xq_rfid
├── 依赖：base, product, stock, mrp, quality_control, mrp_workorder
└── 功能：RFID 标签管理

quality_report
├── 依赖：stock
└── 功能：品质报告打印

delivery_report
├── 依赖：base, stock, sale, account
└── 功能：交货单打印增强

merge_picking_orders
├── 依赖：stock
└── 功能：合并调拨单

auto_database_backup
├── 依赖：base, mail
└── 功能：自动数据库备份
```

## 核心功能总结

### 1. 库存单位管理 (stock_unit_mgmt)

- **产品单位配置**: 支持多种单位（卷、桶、箱、袋、公斤、平方米等）
- **库存移动单位**: 记录单位数量（`lot_quantity`）和单位名称（`lot_unit_name`）
- **库存统计**: 单位数量汇总、实际卷数统计、桶数统计
- **增强条码验证**: 批次号验证、重复扫描检测、数量一致性验证
- **扫描顺序管理**: 包裹中记录按扫描顺序排序

### 2. 制造管理

- **剩余组件返回** (mrp_production_return): 处理制造订单剩余组件
- **自动批次号生成** (mrp_auto_lot_generate): 自动生成完成品批次号
- **序列号生成** (serial_no_from_mo): 从制造订单生成序列号

### 3. RFID 管理 (xq_rfid)

- **RFID 标签管理**: 统一管理所有 RFID 标签
- **质检集成**: 通过质量检查点生成 RFID
- **生产溯源**: 记录生产订单、质检、日期

### 4. 报表打印

- **品质报告** (quality_report): 打印品质报告
- **交货单报告** (delivery_report): 打印交货单报告
- **MRP 标签** (xq_mrp_label): 打印制造订单标签

### 5. 工具模块

- **自动数据库备份** (auto_database_backup): 自动备份数据库
- **合并调拨单** (merge_picking_orders): 合并多个调拨单
- **多图片质检** (ps_multi_image_mrp_qc): 多图片选择和管理

## 技术架构

### 数据模型扩展

1. **产品模型** (`product.template`)
   - 单位配置字段
   - 产品属性字段（宽度、长度、厚度、密度等）
   - 第二单位配置

2. **库存模型** (`stock.move.line`, `stock.quant`, `stock.picking`)
   - 单位数量字段（`lot_quantity`）
   - 单位名称字段（`lot_unit_name`）
   - 扫描顺序字段（`scan_sequence`）
   - 增强条码验证配置

3. **制造模型** (`mrp.production`)
   - 剩余组件处理
   - 批次号生成
   - 序列号生成

4. **RFID 模型** (`rfid.tag`, `rfid.device.config`)
   - RFID 标签管理
   - RFID 设备配置

### 控制器扩展

1. **条码控制器** (`StockBarcodeController`)
   - 扩展条码扫描功能
   - 会话管理
   - 单位信息设置
   - 扫描顺序管理

### 视图扩展

1. **产品视图**: 单位配置、产品属性
2. **库存视图**: 单位信息显示、增强条码验证配置
3. **制造视图**: 剩余组件处理、批次号生成
4. **RFID 视图**: RFID 标签管理、设备配置

## 使用场景

### 1. 入库管理
- 使用条码扫描入库
- 自动验证批次号
- 记录单位数量
- 保持扫描顺序

### 2. 制造管理
- 自动生成批次号
- 处理剩余组件
- 生成序列号

### 3. 质检管理
- 生成 RFID 标签
- 多图片质检
- 打印标签

### 4. 报表打印
- 打印品质报告
- 打印交货单报告
- 打印制造订单标签

## 注意事项

1. **模块依赖**: 某些模块依赖于其他模块，安装时需要注意依赖关系
2. **数据迁移**: 某些模块整合了其他模块的功能，需要注意数据迁移
3. **配置要求**: 某些功能需要配置才能使用（如增强条码验证）
4. **性能影响**: 某些功能可能影响性能（如单位数量计算）

## 版本兼容性

- **Odoo 版本**: 18.0+
- **Python 版本**: 3.8+
- **数据库**: PostgreSQL 12+

## 许可证

- 大部分模块使用 **LGPL-3** 许可证
- 部分模块使用 **AGPL-3** 许可证
- 部分模块使用 **OPL-1** 许可证

## 维护与支持

- **作者**: memory, Grit, Cybrosys Techno Solutions, PySquad Informatics LLP
- **网站**: https://ifangtech.com
- **版本**: 详见各模块的 `__manifest__.py` 文件

---

**最后更新**: 2025-11-12  
**文档版本**: 1.0

