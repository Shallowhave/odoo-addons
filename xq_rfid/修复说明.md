# RFID 模块修复说明

**修复日期**: 2025-10-17  
**问题**: 约束冲突导致无法生成 RFID

---

## 🐛 问题描述

用户在质检通过时遇到错误：

```
duplicate key value violates unique constraint "rfid_tag_uniq_product"
Key (product_id)=(39) already exists.
```

**原因**: 
- 旧版本代码中有不合理的唯一约束：`rfid_tag_uniq_product`
- 这个约束规定"一个产品只能有一个 RFID"
- 但实际上，同一产品可以有多个生产批次，每个批次都应该有自己的 RFID

---

## ✅ 解决方案

### 1️⃣ 代码修复

**修改文件**: `models/rfid_tag.py`

```python
# 之前（错误）
_sql_constraints = [
    ('rfid_tag_uniq_name', 'unique (name)', "RFID 编号必须唯一！"),
    ('rfid_tag_uniq_picking', 'unique (picking_id)', "一个调拨单只能关联一个 RFID 标签！"),
    ('rfid_tag_uniq_product', 'unique (product_id)', "一个产品只能关联一个 RFID 标签！"),  # ❌ 不合理
    ('rfid_tag_uniq_stock_prod_lot', 'unique (stock_prod_lot_id)', "一个批次/序列号只能关联一个 RFID 标签！")
]

# 现在（正确）
_sql_constraints = [
    ('rfid_tag_uniq_name', 'unique (name)', "RFID 编号必须唯一！"),  # ✅ 保留
    ('rfid_tag_uniq_stock_prod_lot', 'unique (stock_prod_lot_id)', "一个批次/序列号只能关联一个 RFID 标签！")  # ✅ 保留
]
```

**修改文件**: `models/quality_check.py`
- 改进错误处理，先生成 RFID 再通过质检
- 避免在事务失败后调用 message_post

### 2️⃣ 数据库迁移

⚠️ **必须执行**: 删除数据库中的旧约束

```sql
-- 连接数据库
psql -U odoo -d your_database

-- 删除旧约束
ALTER TABLE rfid_tag DROP CONSTRAINT IF EXISTS rfid_tag_uniq_product;
ALTER TABLE rfid_tag DROP CONSTRAINT IF EXISTS rfid_tag_uniq_picking;

-- 退出
\q
```

---

## 📋 修复步骤

### 方案 A：自动修复（推荐）

```bash
# 1. 更新模块代码（已完成）
# 2. 升级模块
./odoo-bin -u xq_rfid -d your_database

# 3. 如果遇到错误，执行方案 B
```

### 方案 B：手动修复（如果方案 A 失败）

```bash
# 1. 连接数据库并删除约束
psql -U odoo -d your_database

# 2. 执行 SQL
ALTER TABLE rfid_tag DROP CONSTRAINT IF EXISTS rfid_tag_uniq_product;
ALTER TABLE rfid_tag DROP CONSTRAINT IF EXISTS rfid_tag_uniq_picking;

# 3. 退出数据库
\q

# 4. 重启 Odoo
sudo systemctl restart odoo
```

---

## ✅ 验证修复

### 测试场景

```
1. 创建生产订单 MO001
   - 产品：产品 A
   - 批次号：LOT001
   
2. 执行 RFID 质检，点击"通过"
   - ✅ 应该成功生成 RFID000001

3. 创建生产订单 MO002
   - 产品：产品 A（同一产品）
   - 批次号：LOT002（不同批次）
   
4. 执行 RFID 质检，点击"通过"
   - ✅ 应该成功生成 RFID000002（之前会报错）
```

### 验证 SQL

```sql
-- 检查约束（应该只有两个）
SELECT conname 
FROM pg_constraint 
WHERE conrelid = 'rfid_tag'::regclass 
AND conname LIKE 'rfid_tag_uniq%';

-- 期望结果：
-- rfid_tag_uniq_name
-- rfid_tag_uniq_stock_prod_lot
```

---

## 📊 约束对比

| 约束 | 之前 | 现在 | 说明 |
|------|------|------|------|
| RFID 编号唯一 | ✅ | ✅ | 保留 - 每个 RFID 编号全局唯一 |
| 批次号唯一 | ✅ | ✅ | 保留 - 每个批次只能有一个 RFID |
| **产品唯一** | ⚠️ | ❌ | **移除 - 同一产品可以有多个 RFID** |
| **调拨单唯一** | ⚠️ | ❌ | **移除 - 同一调拨单可以有多个 RFID** |

---

## 📚 相关文档

- **`QUICK_FIX.md`** - 3 步快速修复指南 ⭐ 推荐
- **`DATABASE_MIGRATION.md`** - 详细数据库迁移指南
- **`UPDATE_2025_10_17.md`** - 完整更新说明
- **`使用说明.md`** - 模块使用指南
- **`功能更新说明.md`** - 功能变更说明

---

## 🔍 技术细节

### 为什么移除产品唯一约束？

**业务场景**:
```
产品 A（手机）
├── 批次 2025-01-001 → RFID000001 ✅
├── 批次 2025-01-002 → RFID000002 ✅
├── 批次 2025-01-003 → RFID000003 ✅
└── ...
```

如果有产品唯一约束，第二个批次就无法生成 RFID 了。

### 为什么保留批次唯一约束？

**防止重复**:
```
批次 2025-01-001
├── 第一次质检 → RFID000001 ✅
└── 第二次质检 → ❌ 错误：该批次已有 RFID（正确行为）
```

这确保了每个批次只有一个 RFID，防止重复生成。

---

## 💡 注意事项

### ⚠️ 备份数据库

修改前请备份：

```bash
pg_dump -U odoo -d your_database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### ✅ 已有数据

- 已存在的 RFID 标签不受影响
- 数据完整性保持不变
- 只是移除了不合理的限制

### 🔄 升级建议

1. 在测试环境先测试
2. 备份生产数据库
3. 升级生产环境
4. 验证功能正常

---

## 🎯 修复效果

### 修复前

```
❌ 同一产品无法生成第二个 RFID
❌ 质检时报错：duplicate key value violates unique constraint
❌ 生产流程中断
```

### 修复后

```
✅ 同一产品可以有多个 RFID（不同批次）
✅ 每个批次有唯一的 RFID（防伪溯源）
✅ 质检流程顺畅
```

---

## 📞 技术支持

- **开发者**: Grit
- **官网**: https://ifangtech.com
- **问题反馈**: 请提供详细的错误日志

---

## ✨ 总结

这次修复解决了一个关键的设计缺陷：

- ❌ **旧设计**: 一个产品 = 一个 RFID（不合理）
- ✅ **新设计**: 一个批次 = 一个 RFID（合理）

现在可以正常为同一产品的不同批次生成 RFID 标签了！

**立即开始**: 查看 `QUICK_FIX.md` 获取 3 步快速修复方案 🚀

