# RFID 模块流程简化更新

**更新日期**: 2025-10-17  
**更新内容**: 简化 RFID 生成流程，质检通过时自动生成

---

## 📋 更新摘要

根据用户反馈，将 RFID 生成流程简化：
- ❌ **移除**: 手动点击"生成 RFID"按钮
- ✅ **新增**: 质检通过时自动生成 RFID
- ✅ **改进**: 直接使用生产订单的成品批次号（`lot_producing_id`）
- 🔧 **修复**: 移除不合理的唯一约束（允许同一产品有多个 RFID）

---

## 🔄 修改的文件

### 后端文件

#### `models/rfid_tag.py`
**修改内容**:
- 移除 `rfid_tag_uniq_product` 约束（一个产品可以有多个 RFID）
- 移除 `rfid_tag_uniq_picking` 约束（一个调拨单可以有多个 RFID）
- 保留 `rfid_tag_uniq_name` 约束（RFID 编号唯一）
- 保留 `rfid_tag_uniq_stock_prod_lot` 约束（批次号唯一）

**原因**：
同一个产品可以有多个生产批次，每个批次都应该有自己的 RFID 标签。

#### `models/quality_check.py`
**修改内容**:
- 移除 `can_generate_rfid` 计算字段和 `action_generate_rfid` 方法
- 添加 `do_pass()` 方法重写，质检通过时自动生成 RFID
- 使用 `production_id.lot_producing_id` 作为批次号

**核心逻辑**:
```python
def do_pass(self):
    """质检通过时自动生成 RFID 标签"""
    res = super(QualityCheck, self).do_pass()
    
    # 如果是 RFID 标签类型的质检，自动生成 RFID
    if self.test_type == 'rfid_label' and self.production_id and not self.rfid_tag_id:
        lot = self.production_id.lot_producing_id  # 使用成品批次号
        
        if lot:
            # 调用生产订单的生成方法
            rfid_tag = self.production_id.generate_rfid_for_lot(
                lot_id=lot,
                quality_check_id=self.id
            )
            
            # 关联到当前质检
            self.rfid_tag_id = rfid_tag.id
    
    return res
```

### 前端文件

#### `static/src/components/rfid_generation_wizard.xml`
**修改内容**:
- 移除"生成 RFID"按钮
- 简化界面，只显示批次号和 RFID 状态
- 添加提示信息：点击"通过"后自动生成

**界面布局**:
- 成品批次号显示
- RFID 状态显示（已生成/通过后自动生成）
- RFID 编号显示（如果已生成）
- 提示信息

#### `static/src/components/rfid_generation_wizard.js`
**修改内容**:
- 移除 `generateRfid()` 方法和相关逻辑
- 修改为从生产订单读取 `lot_producing_id`
- 简化状态管理

**核心逻辑**:
```javascript
async loadProductionLot() {
    const recordData = this.props.record.data;
    
    // 获取生产订单的成品批次号
    if (recordData.production_id && recordData.production_id[0]) {
        const production = await this.orm.read(
            'mrp.production',
            [recordData.production_id[0]],
            ['lot_producing_id']
        );
        
        if (production && production.length > 0 && production[0].lot_producing_id) {
            this.state.productionLotNumber = production[0].lot_producing_id[1];
        }
    }
}
```

#### `static/src/components/mrp_quality_check_confirmation_dialog.js`
**修改内容**:
- 移除自定义的 `validate()` 方法
- 简化组件注册逻辑
- 移除验证 RFID 是否生成的检查

#### `static/src/components/mrp_quality_check_confirmation_dialog.xml`
**修改内容**:
- 移除 RFID 专用的"确认 RFID"按钮
- 保留标准的"通过"按钮
- 简化 XML 结构

### 文档文件

#### `使用说明.md`
更新内容:
- 修改"步骤 2"，说明自动生成流程
- 移除手动生成的步骤说明

#### `功能更新说明.md`
更新内容:
- 添加"2025-10-17 更新"说明
- 修改工作流程描述
- 更新关键特性列表

#### `README.md`
更新内容:
- 更新"生成 RFID"步骤
- 更新质检集成流程图
- 更新版本历史

---

## 🎯 新的工作流程

### 用户操作流程

```
1. 创建质检点
   └─ 测试类型：选择 "RFID 标签"

2. 生产订单执行到 RFID 质检点
   ├─ 质检对话框弹出
   ├─ 显示：成品批次号
   ├─ 显示：RFID 状态（通过后自动生成）
   └─ 点击"通过"按钮

3. 系统自动处理
   ├─ 执行质检通过逻辑
   ├─ 自动为成品批次号生成 RFID
   ├─ 关联生产订单、质检记录
   ├─ 记录生产日期
   └─ 继续后续工序

4. 查看结果
   └─ 生产订单 → RFID 标签页
```

### 技术流程

```
用户点击"通过"
    ↓
quality.check.do_pass()
    ↓
判断: test_type == 'rfid_label'?
    ↓ Yes
获取: production_id.lot_producing_id
    ↓
调用: production.generate_rfid_for_lot()
    ↓
创建 RFID 标签
    ↓
关联到质检记录
    ↓
返回质检通过结果
```

---

## ✅ 优势对比

### 之前的流程
1. 质检对话框弹出
2. 查看批次号（可能为空）
3. **手动点击"生成 RFID"按钮**
4. 等待生成完成
5. 点击"通过"按钮

**缺点**:
- 需要两次点击操作
- 批次号可能为空导致困惑
- 流程较复杂

### 现在的流程
1. 质检对话框弹出
2. 查看成品批次号
3. **点击"通过"按钮（自动生成 RFID）**

**优点**:
- ✅ 一键操作，流程简化
- ✅ 直接使用成品批次号，数据准确
- ✅ 用户体验更流畅
- ✅ 减少操作失误

---

## 🔍 关键改进点

### 1. 使用成品批次号
**之前**: 使用质检记录的 `lot_id`（可能为空）  
**现在**: 使用生产订单的 `lot_producing_id`（成品批次号，更准确）

### 2. 自动生成时机
**之前**: 手动点击按钮  
**现在**: 质检通过时自动生成

### 3. 用户界面
**之前**: 显示生成按钮和状态  
**现在**: 只显示批次号和状态，无需手动操作

### 4. 错误处理
**之前**: 生成失败会阻止质检通过  
**现在**: 生成失败只记录日志，不影响质检流程

---

## 📝 数据流向

```
生产订单 (mrp.production)
    ↓
    lot_producing_id (成品批次号)
    ↓
质检记录 (quality.check)
    ↓
    do_pass() 方法
    ↓
RFID 标签 (rfid.tag)
    ├── name: RFID000001 (自动生成)
    ├── stock_prod_lot_id: 成品批次号
    ├── product_id: 产品
    ├── production_id: 生产订单
    ├── quality_check_id: 质检记录
    └── production_date: 生产日期
```

---

## 🧪 测试要点

### 功能测试
- [ ] RFID 质检点能正常触发
- [ ] 质检对话框显示成品批次号
- [ ] 点击"通过"后自动生成 RFID
- [ ] RFID 编号唯一
- [ ] 批次号关联正确
- [ ] 生产订单关联正确

### 异常场景测试
- [ ] 成品批次号未生成时的处理
- [ ] 批次号已有 RFID 时的重复检测
- [ ] RFID 生成失败不影响质检通过
- [ ] 硬件设备写入失败的处理

### 兼容性测试
- [ ] 其他类型的质检点不受影响
- [ ] 已有的 RFID 数据不受影响
- [ ] 多个质检点的执行顺序正确

---

## 💡 使用建议

### 1. 质检点配置
- 在**最后一道工序**设置 RFID 质检点
- 确保该工序已生成成品批次号
- 测试类型选择 **"RFID 标签"**

### 2. 生产流程
```
开始生产 → 各工序 → RFID 质检点 → 点击通过 → 完成生产
                                  ↓
                            (自动生成 RFID)
```

### 3. 数据查看
- 生产订单 → 顶部"RFID 标签"按钮
- 生产订单 → "RFID 标签"标签页
- RFID 菜单 → RFID 标签列表

---

## 🔧 技术参考

### 后端重写方法
```python
class QualityCheck(models.Model):
    _inherit = 'quality.check'
    
    def do_pass(self):
        """重写质检通过方法"""
        res = super(QualityCheck, self).do_pass()
        # 自动生成 RFID 逻辑
        return res
```

### 前端组件
```javascript
// 只显示状态，不需要手动操作
export class RfidGenerationWizard extends Component {
    async loadProductionLot() {
        // 从生产订单读取成品批次号
    }
}
```

---

## 📞 技术支持

- **开发者**: Grit
- **官网**: https://ifangtech.com
- **版本**: 18.0.1.0.0
- **更新日期**: 2025-10-17

---

## 🗄️ 数据库迁移

⚠️ **重要**: 升级模块后需要移除数据库中的旧约束

### 快速迁移

```bash
# 方案 1：升级模块（Odoo 会尝试自动处理）
./odoo-bin -u xq_rfid -d your_database
```

如果遇到约束冲突错误，请执行以下 SQL：

```sql
-- 连接数据库
psql -U odoo -d your_database

-- 删除旧约束
ALTER TABLE rfid_tag DROP CONSTRAINT IF EXISTS rfid_tag_uniq_product;
ALTER TABLE rfid_tag DROP CONSTRAINT IF EXISTS rfid_tag_uniq_picking;

-- 验证
SELECT conname FROM pg_constraint WHERE conrelid = 'rfid_tag'::regclass AND conname LIKE 'rfid_tag_uniq%';
```

**详细说明**: 请查看 `DATABASE_MIGRATION.md` 文档

---

## 🎉 总结

此次更新大幅简化了 RFID 生成流程，从"查看 → 生成 → 通过"简化为"查看 → 通过"，提升了用户体验和操作效率。同时，使用生产订单的成品批次号确保了数据的准确性和完整性。

**重要修复**: 移除了不合理的产品唯一约束，现在可以为同一产品的不同批次生成多个 RFID 标签了！

**一句话总结**: 点击"通过"，RFID 自动生成！✨

