# RFID 模块功能更新说明

## 📝 更新日期
2025-10-15

## 🔄 主要更新

### 1. ✅ 删除了 Excel 导入功能

**删除的文件**：
- ❌ `wizard/rfid_tag_import.py` - 导入功能代码
- ❌ `wizard/rfid_tag_import_views.xml` - 导入视图
- ❌ `wizard/message_wizard.py` - 导入消息向导
- ❌ `wizard/message_wizard_views.xml` - 消息向导视图
- ❌ `wizard/__init__.py` - wizard 初始化文件
- ❌ `static/src/RFID_tag_template.xlsx` - Excel 模板文件

**更新的文件**：
- ✅ `__manifest__.py` - 移除了导入相关文件引用和依赖
- ✅ `security/ir.model.access.csv` - 移除了导入向导的权限配置
- ✅ `使用说明.md` - 更新了相关说明

**原因**：
- 通过质检流程生成 RFID 更规范
- 减少模块复杂度
- 避免手动导入可能带来的数据不一致

### 2. ✅ 简化为自动生成 RFID 功能（2025-10-17 更新）

**修改的文件**：
- ✅ `models/quality_check.py` - 添加了 `do_pass()` 方法，质检通过时自动生成 RFID
- ✅ `static/src/components/rfid_generation_wizard.js` - 简化为只显示批次号和状态
- ✅ `static/src/components/rfid_generation_wizard.xml` - 移除手动生成按钮

**现在的工作方式**：
- ✅ **自动生成** - 质检通过时自动为成品批次号生成 RFID
- ✅ **使用成品批次号** - 直接使用 `lot_producing_id`，无需手动输入
- ✅ **简化流程** - 用户只需点击"通过"按钮，系统自动处理 RFID 生成

### 3. ✅ RFID 与序列号严格对应

**核心逻辑**（已验证）：
```python
# quality_check.py
def action_generate_rfid(self):
    # 必须有序列号
    if not self.lot_id:
        raise UserError(_('无法生成 RFID：未设置批次/序列号！'))
    
    # 为序列号生成 RFID
    rfid_tag = self.production_id.generate_rfid_for_lot(
        lot_id=self.lot_id,  # 传入序列号
        quality_check_id=self.id
    )
```

```python
# mrp_production.py
def generate_rfid_for_lot(self, lot_id=None, quality_check_id=None):
    # 使用指定的序列号
    lot = lot_id or self.lot_producing_id
    
    # 检查该序列号是否已有 RFID（避免重复）
    existing_rfid = self.env['rfid.tag'].search([
        ('stock_prod_lot_id', '=', lot.id)
    ], limit=1)
    
    if existing_rfid:
        return existing_rfid
    
    # 创建 RFID，绑定序列号
    rfid_tag = self.env['rfid.tag'].create({
        'name': rfid_number,
        'stock_prod_lot_id': lot.id,  # 关联序列号 ⭐
        'product_id': self.product_id.id,
        'production_id': self.id,
        'quality_check_id': quality_check_id,
    })
```

**特性**：
- ✅ **一对一关系** - 一个序列号对应一个 RFID
- ✅ **自动检查重复** - 同一序列号不会重复生成 RFID
- ✅ **完整溯源** - RFID 记录包含序列号、产品、生产订单、质检记录

## 📊 功能对比

| 功能 | 之前 | 现在 |
|------|------|------|
| **创建 RFID 方式** | Excel 导入 / 质检生成 | 只能通过质检生成 |
| **生成时机** | 手动 / 自动（质检通过） | 只能手动触发 |
| **序列号关联** | 可选 | 必填 ⭐ |
| **重复检测** | Excel 导入时检测 | 自动检测序列号 RFID |
| **数据一致性** | 依赖手动输入 | 系统自动保证 |

## 🎯 当前工作流程

### 标准流程

1. **创建质检点**
   - 进入：质量 → 质量控制 → 质量检查点
   - 测试类型：选择 **RFID 标签**
   - 配置工序、产品等

2. **生产过程**
   - 创建生产订单
   - 开始生产
   - 执行到 RFID 质检点

3. **质检生成 RFID**
   - 质检向导弹出
   - **填写序列号**（必填）⭐
   - 点击 **"生成 RFID"** 按钮
   - 系统自动：
     - ✅ 生成唯一 RFID 编号
     - ✅ 绑定序列号
     - ✅ 关联生产订单
     - ✅ 记录质检信息
     - ✅ 记录生产日期
   - 点击"通过"完成质检

4. **查看 RFID**
   - 生产订单 → RFID 标签页
   - 或 RFID → RFID 标签菜单

### 关键特性

- ✅ **自动生成** - 质检通过时自动生成，无需手动操作
- ✅ **成品批次号** - 使用生产订单的成品批次号（lot_producing_id）
- ✅ **防止重复** - 同一批次号不会重复生成 RFID
- ✅ **完整溯源** - 所有信息自动关联
- ✅ **简化流程** - 用户只需点击"通过"，系统自动处理

## 🔧 技术细节

### 数据结构

```
RFID 标签 (rfid.tag)
├── name (RFID 编号) - 自动生成，唯一
├── stock_prod_lot_id (序列号) - 必填 ⭐
├── product_id (产品) - 来自生产订单
├── production_id (生产订单) - 自动关联
├── production_date (生产日期) - 自动记录
└── quality_check_id (质检记录) - 自动关联
```

### 唯一性约束

```python
# rfid_tag.py
_sql_constraints = [
    ('name_unique', 'unique(name)', 'RFID 编号必须唯一！'),
    ('lot_unique', 'unique(stock_prod_lot_id)', '每个批次/序列号只能有一个 RFID 标签！'),
]
```

## ⚠️ 重要变更

### 不再支持的功能

1. **❌ Excel 批量导入**
   - 无法通过 Excel 文件批量创建 RFID
   - 所有 RFID 必须通过质检流程生成

2. **❌ 自动生成 RFID**
   - 质检通过时不会自动生成 RFID
   - 必须手动点击"生成 RFID"按钮

3. **❌ 无序列号的 RFID**
   - 所有 RFID 必须关联序列号
   - 不能创建独立的 RFID 记录

### 升级影响

**对于已有数据**：
- ✅ 已存在的 RFID 数据不受影响
- ✅ 已有的导入数据保持不变
- ⚠️ 升级后无法再使用导入功能

**对于新数据**：
- ✅ 所有新 RFID 必须通过质检生成
- ✅ 必须有序列号才能生成
- ✅ 自动防止重复

## 📋 升级步骤

1. **备份数据库**（可选但推荐）
   ```bash
   pg_dump your_database > backup.sql
   ```

2. **升级模块**
   ```bash
   ./odoo-bin -u xq_rfid -d your_database
   ```

3. **验证功能**
   - 创建测试质检点
   - 测试 RFID 生成
   - 检查序列号关联

## ✅ 优势

### 简化模块

- ✅ 删除了 500+ 行导入代码
- ✅ 移除了 Excel 依赖 (`xlrd`, `openpyxl`)
- ✅ 减少了配置复杂度
- ✅ 降低了维护成本

### 提高质量

- ✅ 数据来源单一（只能通过质检）
- ✅ 自动保证数据一致性
- ✅ 强制流程规范
- ✅ 减少人为错误

### 更好的溯源

- ✅ 所有 RFID 都有质检记录
- ✅ 序列号关联强制且唯一
- ✅ 生产过程完整记录
- ✅ 防伪溯源更可靠

## 📞 支持

如有疑问，请查看：
- `使用说明.md` - 详细使用指南
- `models/quality_check.py` - 生成逻辑源码
- `models/mrp_production.py` - RFID 创建源码

---

**开发**: Grit  
**网站**: https://ifangtech.com  
**版本**: 18.0.1.0.0  
**更新日期**: 2025-10-15

