# Odoo 库存移动字段说明

## stock.move.line（库存移动行）字段

### 1. `quantity`（数量）
- **含义**：移动行的实际数量
- **单位**：以 `product_uom_id`（产品单位）为单位
- **用途**：表示该移动行实际处理的产品数量
- **示例**：如果产品单位是"卷"，quantity=1.0 表示 1 卷

### 2. `quantity_product_uom`（产品单位数量）
- **含义**：以产品默认单位（UoM）表示的数量
- **单位**：以产品的默认单位（`product_id.uom_id`）为单位
- **用途**：统一转换为产品的默认单位，便于计算和显示
- **计算**：从 `quantity` 转换而来，考虑 `product_uom_id` 和产品默认单位的换算关系

### 3. `qty_done`（已完成数量）
- **含义**：实际完成/处理的数量
- **单位**：以 `product_uom_id` 为单位
- **用途**：在条码应用中，表示已扫码验证的数量
- **说明**：在您的系统中，`qty_done > 0` 表示该批次号已被扫码验证

## stock.move（库存移动）字段

### 1. `product_uom_qty`（产品单位数量）
- **含义**：移动中计划处理的产品总数量
- **单位**：以产品的默认单位（`product_id.uom_id`）为单位
- **用途**：表示整个移动（所有移动行）需要处理的总数量
- **示例**：如果移动需要处理 4 卷产品，`product_uom_qty = 4.0`

### 2. `quantity`（数量）
- **含义**：移动中实际处理的产品总数量
- **单位**：以产品的默认单位（`product_id.uom_id`）为单位
- **用途**：表示整个移动实际处理的总数量（所有移动行的数量总和）

## 字段关系

```
stock.move (移动)
├── product_uom_qty = 4.0 (计划处理 4 卷)
└── move_line_ids (移动行列表)
    ├── move_line_1
    │   ├── quantity = 1.0 (实际处理 1 卷)
    │   ├── quantity_product_uom = 1.0 (转换为产品单位：1 卷)
    │   └── qty_done = 1.0 (已扫码验证 1 卷)
    ├── move_line_2
    │   ├── quantity = 1.0
    │   ├── quantity_product_uom = 1.0
    │   └── qty_done = 1.0
    ├── move_line_3
    │   ├── quantity = 1.0
    │   ├── quantity_product_uom = 1.0
    │   └── qty_done = 1.0
    └── move_line_4
        ├── quantity = 1.0
        ├── quantity_product_uom = 1.0
        └── qty_done = 1.0
```

## 批次号场景（按序列号方式）

按照序列号的方式处理批次号时：

1. **每个批次号对应一个移动行**
   - 每个批次号创建一个 `stock.move.line` 记录
   - 每个移动行的 `quantity = 1.0`（固定为 1.0）

2. **移动的总数量**
   - `stock.move.product_uom_qty = 4.0`（如果有 4 个批次号）
   - 所有移动行的 `quantity` 总和 = `product_uom_qty`

3. **条码应用显示**
   - 显示格式：`qty_done / product_uom_qty 单位`
   - 示例：`1/4 卷` 表示已完成 1 卷，总共需要 4 卷
   - 但如果每个批次号都是 1.0，应该显示为 `1/1 卷` 或 `1 卷`

## 问题分析

如果界面显示 "1/4 卷"，可能的原因：

1. **移动行的 `quantity` 不是 1.0**
   - 如果移动行被分配了 1/4 的数量，而不是完整的 1.0
   - 需要确保每个批次号对应的移动行 `quantity = 1.0`

2. **移动的 `product_uom_qty` 是 4.0**
   - 如果移动的总数量是 4.0，但移动行被分配了部分数量
   - 需要确保每个移动行的 `quantity = 1.0`，并且移动的总数量 = 移动行数量

3. **显示逻辑问题**
   - 条码应用可能使用 `move.product_uom_qty` 作为分母
   - 但应该使用移动行的 `quantity` 或移动的总移动行数量

## 解决方案

按照序列号的方式，应该：

1. **确保每个移动行的 `quantity = 1.0`**
   - 在 `_onchange_quantity` 中强制设置
   - 在控制器中确保扫码时设置为 1.0

2. **确保移动的总数量正确**
   - `move.product_uom_qty` 应该等于移动行的数量
   - 如果有 4 个批次号，`product_uom_qty = 4.0`

3. **修改显示逻辑（如需要）**
   - 如果条码应用显示 "1/4 卷" 不符合预期
   - 可能需要自定义显示逻辑，显示为 "1 卷" 而不是 "1/4 卷"

