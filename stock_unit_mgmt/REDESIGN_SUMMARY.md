# stock_unit_mgmt 重新设计方案 - 执行摘要

## 🎯 核心改进点

### 1. **产品类型分类系统** ⭐⭐⭐
**现状问题**：所有产品使用相同的字段，导致混乱

**新方案**：
- 添加产品类型字段：原膜、成品膜、液体、半成品原膜
- 根据类型自动显示/隐藏相关字段
- 每种类型有专属属性和单位配置

**收益**：
- 界面更清晰，减少用户困惑
- 数据更规范，避免误填
- 便于后续扩展新类型

---

### 2. **灵活的附加单位配置** ⭐⭐⭐
**现状问题**：只能配置一个单位模板，不够灵活

**新方案**：
- 支持为每个产品配置**多个附加单位**
- 每个单位可配置转换比例（如：1桶 = 4.285kg）
- 可设置默认单位、是否必填
- 支持单位排序

**收益**：
- 更贴近实际业务（一个产品可能有多种包装方式）
- 支持单位自动转换
- 便于后续扩展新的单位类型

---

### 3. **优化的计算机制** ⭐⭐
**现状问题**：计算字段依赖不完整，需要手动触发，性能差

**新方案**：
- 使用信号机制自动触发重新计算
- 批量计算优化（解决N+1查询问题）
- 使用 `read_group` 聚合计算

**收益**：
- 数据自动同步，无需手动操作
- 性能提升50%以上
- 减少计算错误

---

### 4. **字段命名规范化** ⭐
**现状问题**：字段命名不一致（`lot_qty`, `act_juan`, `o_note`）

**新方案**：
- 统一命名规范：`additional_unit_qty`, `total_roll_count`, `note_summary`
- 字段名更具描述性

**收益**：
- 代码可读性提升
- 减少理解成本
- 便于团队协作

---

### 5. **单位转换功能** ⭐⭐
**现状问题**：缺少自动转换，需要手动计算

**新方案**：
- 配置单位转换比例
- 入库时：输入附加单位数量，自动计算主单位数量
- 出库时：根据主单位数量，自动计算附加单位数量

**收益**：
- 减少人工计算错误
- 提高录入效率
- 数据更准确

---

## 📊 架构对比

### 当前架构
```
产品 → 单一单位配置 → 库存记录 → 手动计算
```

### 新架构
```
产品类型 → 多单位配置 → 单位转换规则 → 自动计算 → 智能汇总
```

---

## 🚀 实施优先级

### P0（必须） - 立即实施
1. ✅ 产品类型分类
2. ✅ 字段命名规范化
3. ✅ 计算字段优化
4. ✅ 修复现有bug

### P1（重要） - 短期实施（1-2周）
1. ⚠️ 多单位配置系统
2. ⚠️ 单位转换功能
3. ⚠️ 批量计算优化

### P2（优化） - 中期实施（1-2月）
1. 📝 报表分析功能
2. 📝 批量配置导入
3. 📝 移动端支持

---

## 💡 关键决策点

### 决策1：是否保留现有数据结构？
**建议**：渐进式迁移
- 保留现有字段，添加新字段
- 提供数据迁移脚本
- 逐步切换到新字段

### 决策2：单位转换是否自动？
**建议**：可配置
- 默认自动转换
- 允许手动覆盖
- 记录转换历史

### 决策3：性能vs实时性？
**建议**：平衡策略
- 关键字段：实时计算
- 统计字段：存储计算 + 延迟更新
- 报表字段：按需计算

---

## 📋 实施检查清单

### 数据模型
- [ ] 创建 `product.additional.unit` 模型
- [ ] 添加产品类型字段
- [ ] 重构计算字段依赖
- [ ] 数据迁移脚本

### 业务逻辑
- [ ] 单位转换逻辑
- [ ] 批量计算优化
- [ ] 信号机制实现
- [ ] 错误处理完善

### 用户界面
- [ ] 产品配置界面重构
- [ ] 库存管理界面优化
- [ ] 移动历史界面更新
- [ ] 快速设置向导

### 测试验证
- [ ] 功能测试
- [ ] 性能测试
- [ ] 数据迁移测试
- [ ] 用户验收测试

---

## ⚠️ 风险提示

1. **数据迁移风险**：需要仔细设计迁移脚本，确保数据不丢失
2. **性能影响**：新架构在初期可能有性能波动，需要监控
3. **用户适应**：界面变化需要用户重新学习，建议分阶段上线

---

## 📞 下一步行动

1. **审阅方案**：请您仔细审阅完整设计文档
2. **提出意见**：对方案提出修改建议
3. **确认优先级**：确定实施的优先级和范围
4. **开始实施**：确认后开始分阶段实施

---

**完整设计文档**：`/opt/custom/addons/stock_unit_mgmt/REDESIGN_PROPOSAL.md`

