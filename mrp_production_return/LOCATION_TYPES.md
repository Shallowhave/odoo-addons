# 仓库位置类型说明

## 📋 概述

在处理制造订单剩余组件时，系统提供了四种返回策略，每种策略使用不同类型的仓库位置。

---

## 🏭 仓库位置类型对比

| 策略 | 位置类型 | usage | scrap_location | 说明 | 库存影响 |
|------|----------|-------|----------------|------|----------|
| **不良品仓** | 内部库位 | `internal` | `False` | 存放不合格但仍存在的产品 | ✓ 计入库存 |
| **主仓库** | 内部库位 | `internal` | `False` | 正常库存位置 | ✓ 计入库存 |
| **自定义位置** | 内部库位 | `internal` | `False` | 任何内部库位 | ✓ 计入库存 |
| **报废处理** | 虚拟库位 | `inventory` | - | 报废位置（虚拟） | ✗ 不计入库存 |

---

## 📦 详细说明

### 1️⃣ 不良品仓（Defective Warehouse）

**定义**：
- `usage = 'internal'`（内部位置）
- `scrap_location = False`（不是报废位置）
- 优先查找名称包含 "不良" 或 "次品" 的库位

**用途**：
- 存放质量不合格但仍然存在的产品
- 产品可能需要返工、返厂或降价销售
- **库存仍然存在**，只是隔离存放

**示例场景**：
```
原料A检验发现有瑕疵 → 移至不良品仓 → 后续可能：
- 返工修复后重新入库
- 联系供应商退货
- 降价处理销售
```

**系统行为**：
- ✅ 创建库存调拨单（Picking）
- ✅ 从原料位置 → 不良品仓
- ✅ 可选自动确认调拨
- ✅ **库存数量保持不变**（只是位置变化）

---

### 2️⃣ 主仓库（Main Warehouse）

**定义**：
- `usage = 'internal'`（内部位置）
- `scrap_location = False`（不是报废位置）
- 通常是 `warehouse.lot_stock_id`（WH/Stock）

**用途**：
- 将剩余组件返回到正常库存
- 组件质量合格，可以继续使用
- **正常库存**，可用于其他订单

**示例场景**：
```
制造100个产品，实际只需95个 → 剩余5个组件返回主仓库 → 可用于下次生产
```

**系统行为**：
- ✅ 创建库存调拨单（Picking）
- ✅ 从原料位置 → 主仓库
- ✅ 可选自动确认调拨
- ✅ **库存数量保持不变**（只是位置变化）

---

### 3️⃣ 自定义位置（Custom Location）

**定义**：
- `usage = 'internal'`（内部位置）
- 任何您指定的内部库位

**用途**：
- 灵活选择任何内部位置
- 可能是特定项目仓、临时存储区等
- **库存仍然计入**

**示例场景**：
```
项目A的剩余组件 → 移至"项目A专用仓" → 优先用于项目A后续生产
```

**系统行为**：
- ✅ 创建库存调拨单（Picking）
- ✅ 从原料位置 → 自定义位置
- ✅ 可选自动确认调拨
- ✅ **库存数量保持不变**（只是位置变化）

---

### 4️⃣ 报废处理（Scrap）

**定义**：
- 目标位置：虚拟库位 `Virtual Locations/Scrap`
- `usage = 'inventory'`（虚拟位置）
- **不计入实际库存**

**用途**：
- 组件损坏、过期、无法使用
- **永久移除库存**
- 记录报废原因和追溯信息

**示例场景**：
```
原料B已过期 → 报废处理 → 库存减少，记录报废原因
```

**系统行为**：
- ✅ 创建报废单（Scrap Order）
- ✅ 从原料位置 → 虚拟报废位置
- ✅ **立即确认，无需人工验证**
- ❌ **库存数量永久减少**
- ✅ 可追溯报废原因

---

## 🔄 库存影响对比

### 场景：制造订单有 10kg 剩余原料

| 策略 | 原料位置库存 | 目标位置库存 | 总可用库存 |
|------|--------------|--------------|------------|
| **初始** | 100kg | - | 100kg |
| **不良品仓** | 90kg | +10kg（不良品仓） | 100kg ✓ |
| **主仓库** | 90kg | +10kg（主仓库） | 100kg ✓ |
| **自定义位置** | 90kg | +10kg（自定义） | 100kg ✓ |
| **报废处理** | 90kg | 虚拟位置 | **90kg** ✗ |

---

## 🎯 如何选择策略？

```
┌─────────────────────────────────┐
│   组件是否还能使用？              │
└─────────────┬───────────────────┘
              │
       ┌──────┴──────┐
       │             │
      是             否
       │             │
       ↓             ↓
┌─────────────┐  ┌─────────────┐
│ 质量合格吗？ │  │  报废处理   │
└──────┬──────┘  │ （永久移除） │
       │         └─────────────┘
  ┌────┴────┐
  是        否
  │         │
  ↓         ↓
主仓库    不良品仓
（继续用） （隔离待处理）
```

---

## 🛠️ 如何创建不良品仓？

如果系统没有自动推荐不良品仓，您可以手动创建：

### 方法一：在 Odoo 中创建

1. 进入 **库存 → 配置 → 位置**
2. 点击 **创建**
3. 填写信息：
   - **位置名称**：不良品仓
   - **父位置**：选择您的主仓库（如 WH/Stock）
   - **位置类型**：内部位置（Internal Location）
   - **是否为报废位置**：❌ 否
4. 保存

### 方法二：使用现有子库位

如果您的仓库已有子库位（如 Shelf 1, Shelf 2），可以：
- 将其中一个重命名为"不良品仓"
- 或直接使用现有子库位作为不良品存储区

---

## 📊 历史记录对比

| 字段 | 不良品仓/主仓库/自定义 | 报废处理 |
|------|----------------------|----------|
| **return_strategy** | 'defective'/'main'/'custom' | 'scrap' |
| **target_location_id** | ✓ 内部库位 | ✗ None |
| **picking_id** | ✓ 调拨单 | ✗ None |
| **scrap_id** | ✗ None | ✓ 报废单 |
| **auto_confirm** | ✓ 可选 | ✓ 强制 |

---

## ⚠️ 重要提示

### 不良品仓 ≠ 报废位置

| 项目 | 不良品仓 | 报废位置 |
|------|----------|----------|
| **库存计入** | ✅ 是 | ❌ 否 |
| **可逆性** | ✅ 可以移回 | ❌ 不可逆 |
| **用途** | 隔离待处理 | 永久移除 |
| **位置类型** | internal | inventory |
| **scrap_location** | False | True |

### 修复记录

**问题**：之前版本错误地将不良品仓定义为 `scrap_location = True`
**影响**：导致不良品仓和报废位置混淆
**修复**：已更正为 `scrap_location = False`，并优化智能推荐逻辑

---

## 📞 技术支持

如有疑问，请查看：
- 库存调拨单：**库存 → 运营 → 调拨单**
- 报废记录：**库存 → 运营 → 报废**
- 剩余组件历史：**制造 → 报表 → 剩余组件返回历史**

